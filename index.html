<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>é‹è¡Œæ—¥èªŒOCRï¼ˆè»½é‡ç‰ˆï¼‰</title>
<style>
body {
    font-family: sans-serif;
    padding: 20px;
    background: #f2f2f2;
}
h2 {
    margin-bottom: 10px;
}
textarea {
    width: 100%;
    height: 200px;
    margin-top: 10px;
}
button {
    padding: 10px 20px;
    margin-top: 10px;
}
</style>
</head>
<body>

<h2>ğŸš‘ é‹è¡Œæ—¥èªŒOCRï¼ˆè»½é‡ç‰ˆï¼‰</h2>

<input type="file" id="fileInput" accept="image/*"><br><br>
<button onclick="runOCR()">OCRé–‹å§‹</button>
<button onclick="clearOutput()">ã‚¯ãƒªã‚¢</button>

<h3>CSVå‡ºåŠ›</h3>
<textarea id="csvOutput" readonly></textarea>

<!-- è¶…è»½é‡OCRï¼štesseract.js CDNï¼ˆå®‰å®šå‹•ä½œç‰ˆï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.4/dist/tesseract.min.js"></script>

<script>
function clearOutput() {
    document.getElementById("csvOutput").value = "";
}

async function runOCR() {
    const file = document.getElementById("fileInput").files[0];
    if (!file) {
        alert("ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„");
        return;
    }

    document.getElementById("csvOutput").value = "è§£æä¸­â€¦ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„";

    const { createWorker } = Tesseract;
    const worker = createWorker({
        logger: m => console.log(m)
    });

    await worker.load();
    await worker.loadLanguage('eng+jpn');
    await worker.initialize('eng+jpn');

    const result = await worker.recognize(file);
    await worker.terminate();

    let text = result.data.text;
    let rows = text.split("\n").map(r => r.trim()).filter(r => r !== "");

    // æ•°å€¤ãƒ»æ™‚åˆ»ãƒ»ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®ã¿ã«é™å®š
    let clean = rows.map(r =>
        r.match(/[0-9A-Za-z:.]+/g)?.join(" ") || ""
    ).filter(r => r !== "");

    // 6è¡Œã ã‘æŠ½å‡º
    clean = clean.slice(0, 6);

    // å‡ºåº«, å…¥åº«, å‡ºå‹•ç•ªå·, ç¨®åˆ¥, è·é›¢, çµ¦æ²¹é‡ å½¢å¼ã«æ•´å½¢
    let csv = clean
        .map(line => {
            let parts = line.split(" ");
            let out = ["", "", "", "", "", ""];

            if (parts.length >= 1) out[0] = parts[0]; // å‡ºåº«
            if (parts.length >= 2) out[1] = parts[1]; // å…¥åº«
            if (parts.length >= 3) out[2] = parts[2]; // ç•ªå· or çµ¦æ²¹é‡
            if (parts.length >= 4) out[3] = parts[3]; // ç¨®åˆ¥
            if (parts.length >= 5) out[4] = parts[4]; // è·é›¢
            if (parts.length >= 6) out[5] = parts[5]; // çµ¦æ²¹

            return out.join(",");
        })
        .join("\n");

    document.getElementById("csvOutput").value =
        "å‡ºåº«,å…¥åº«,ç•ªå·ãƒ»é‡,ç¨®åˆ¥,è·é›¢,çµ¦æ²¹é‡\n" + csv;
}
</script>

</body>
</html>
