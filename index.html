<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>é‹è¡Œæ—¥èªŒ OCRï¼ˆhonsyo-kadou å°‚ç”¨ï¼‰</title>

<!-- Tesseract.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.3/dist/tesseract.min.js"></script>

<style>
body {
    font-family: sans-serif;
    padding: 20px;
    background: #f2f2f2;
}
h2 { margin-top: 0; }
#output {
    width: 100%;
    height: 200px;
    font-size: 14px;
    white-space: pre;
}
button {
    padding: 10px 20px;
    margin-top: 10px;
    font-size: 16px;
}
</style>
</head>

<body>

<h2>ğŸš‘ é‹è¡Œæ—¥èªŒOCRï¼ˆhonsyo-kadouå°‚ç”¨ï¼‰</h2>

<input type="file" id="imageFile" accept="image/*"><br><br>
<button onclick="runOCR()">OCRé–‹å§‹</button>
<button onclick="clearResult()">ã‚¯ãƒªã‚¢</button>

<h3>CSV å‡ºåŠ›</h3>
<textarea id="output" placeholder="ã“ã“ã«CSVãŒç”Ÿæˆã•ã‚Œã¾ã™"></textarea>

<script>

// -------------------------
// 1ã¨7ã®è£œæ­£
// -------------------------
function fixHandwritingNumbers(text) {
    return text
        .replace(/12:/g, "7:")       // 12:23 â†’ 7:23 ã®èª¤èªè­˜è£œæ­£
        .replace(/l/g, "1")          // l â†’ 1
        .replace(/I/g, "1");         // I â†’ 1
}

// -------------------------
// è¡Œãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰å¿…è¦è¦ç´ ã‚’æŠ½å‡ºã™ã‚‹
// -------------------------
function parseLine(block) {

    block = fixHandwritingNumbers(block);

    const line = block.replace(/\n/g, " ").trim();

    // æ™‚åˆ»ï¼ˆ7:23 å½¢å¼ï¼‰
    const times = line.match(/\b\d{1,2}:\d{2}\b/g) || [];

    const outTime = times[0] || "";
    const inTime  = times[1] || "";

    // ãƒ¡ãƒ¼ã‚¿ãƒ¼ 5ã€œ6æ¡ã®æ•°å­—
    const meter = (line.match(/\b\d{5,6}\b/) || [""])[0];

    // ç¨®åˆ¥ Aã€œJï¼ˆå¤§æ–‡å­—ã®ã¿ï¼‰
    const typeMatch = (line.match(/\b[A-J]\b/) || [""])[0];

    // æ•°å­—ç¾¤
    const nums = line.match(/\d+(\.\d+)?/g) || [];

    let dispatchNo = "";
    let fuel = "";

    // ç¨®åˆ¥ã§æŒ¯ã‚Šåˆ†ã‘
    if(typeMatch === "D"){
        // çµ¦æ²¹
        fuel = nums.find(n => !n.includes(":") && (parseFloat(n) < 200)) || "";
    } else if(typeMatch !== ""){
        // å‡ºå‹•ç•ªå· â†’ 4æ¡ä»¥ä¸Šã®æ•°å­—
        dispatchNo = nums.find(n => n.length >= 3 && !n.includes(":")) || "";
    }

    return {
        outTime,
        inTime,
        dispatchNo,
        type: typeMatch,
        meter,
        fuel
    };
}

// -------------------------
// OCRå®Ÿè¡Œ
// -------------------------
async function runOCR() {

    const file = document.getElementById("imageFile").files[0];
    if (!file) {
        alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
    }

    const output = document.getElementById("output");
    output.value = "OCRè§£æä¸­â€¦å°‘ã—å¾…ã£ã¦ã­â€¦";

    // OCRé–‹å§‹
    const result = await Tesseract.recognize(file, "jpn+eng", {
        tessedit_char_whitelist: "0123456789:ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz."
    });

    let text = result.data.text;

    // è¡Œãƒ–ãƒ­ãƒƒã‚¯ã«åˆ†å‰²ï¼ˆç©ºç™½2è¡Œä»¥ä¸Šã§åˆ†å‰²ï¼‰
    const blocks = text.split(/\n\s*\n+/);

    let csv = "å‡ºåº«,å…¥åº«,å‡ºå‹•ç•ªå·,ç¨®åˆ¥,è·é›¢,çµ¦æ²¹é‡\n";

    for(const b of blocks){
        const d = parseLine(b);
        if(d.outTime || d.dispatchNo || d.meter || d.fuel){
            csv += `${d.outTime},${d.inTime},${d.dispatchNo},${d.type},${d.meter},${d.fuel}\n`;
        }
    }

    output.value = csv;
}

function clearResult(){
    document.getElementById("output").value = "";
}

</script>

</body>
</html>
